!function(e,n,t){"use strict";function i(e){throw s.busy=!1,new Error("StarchupTracker --- "+e)}function r(){var e=new XMLHttpRequest;return e.open("GET","https://api.ipify.org/",!1),e.send(null),e.responseText}function o(e,t,i){var r=new Date;r.setTime(r.getTime()+24*i*60*60*1e3);var o="expires="+r.toUTCString();n.cookie=e+"="+t+"; "+o}function c(e){for(var t=e+"=",i=n.cookie.split(";"),r=0;r<i.length;r++){for(var o=i[r];" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return""}var s={customerId:null,agentId:null,deviceId:null,facilityId:null,access_token:null,cleanerIdentifier:null,source:null},a=function(e,n,t){s.cleanerIdentifier=e,s.facilityId=n,s.source=t;var i=c("tracker_device_id");return i&&i.length>0&&(s.deviceId=i),this},u=function(e,t){function r(e,n){s.busy=!1,t(e,n)}if(s.busy)return g(function(){u(e,t)});s.busy=!0,t&&void 0!==t||(t=l),e||i("Missing event");var o=O("utm_source"),c=O("utm_medium"),a=O("utm_campaign"),d=n.referrer;o&&o.length>0?e.utmSource=o:d&&d.length>1&&(e.utmSource=d),c&&o.length>0&&(e.utmMedium=c),a&&o.length>0&&(e.utmCampaign=a),s.agentId&&(e.agentId=s.agentId),s.customerId&&(e.customerId=s.customerId),s.deviceId&&(e.deviceId=s.deviceId),s.facilityId&&(e.facilityId=s.facilityId),s.source&&(e.source=s.source),s.deviceId?h("POST","Events",e,r):x(function(n,t){n||!t?r():(e.deviceId=t.id,h("POST","Events",e,r))})},d=function(e,n,t,r){function o(e,n){s.busy=!1,r(e,n)}if(s.busy)return g(function(){d(e,n,t,r)});s.busy=!0,r&&void 0!==r||(r=l),e||n||i("Missing user Id"),t||i("Missing token"),s.access_token=t,s.customerId=e,s.agentId=n;var c=function(t,i){if(t||!i)return o();var r={customerId:e,agentId:n};if(i&&i.length>0){var c=i[0].id;r.deviceId=i[0].deviceId,i.forEach(function(e){e.customerId==s.customerId&&e.agentId==s.agentId&&e.id&&e.deviceId&&e.id!==c&&(e.id>c||(c=e.id,r.deviceId=e.deviceId))}),s.deviceId||(s.deviceId=c)}h("PUT","DeviceData/"+s.deviceId,r,function(e,n){if(!e&&i)return o();x(function(e,n){!e&&n&&(s.deviceId=n.id),o()})})};e?I(c):n&&v(c)},f=function(){s.customerId=null,s.deviceId=null,s.access_token=null,o("tracker_device_id",null,0)};a.prototype.trackEvent=u,a.prototype.logIn=d,a.prototype.logOut=f,a.init=a,e.StarchupTracker=a;var l=function(){},g=function(n,t){if(t>10)return n();s.busy&&e.setTimeout(function(){n()},100)},p=function(e,n){n&&void 0!==n||(n=l),h("GET","DeviceData",{where:e},n)},I=function(e){s.customerId||i("Missing customerId"),p({customerId:s.customerId,source:s.source},e)},v=function(e){s.agentId||i("Missing agentId"),p({agentId:s.agentId,source:s.source},e)},m=function(){var n=e.location.hostname;return e.location.port.length>0&&(n=n.replace(":"+e.location.port,"")),"localhost"===n?"http://localhost:3000/api":"dev.starchup.com"===n?"http://dev.starchup.com:3005/api":"stage.starchup.com"===n?"https://sandbox-tracker.starchup.com/api":"https://tracker.starchup.com/api"},h=function(e,n,t,r){r&&void 0!==r||(r=l),e||i("Missing method"),n||i("Missing resource"),t||i("Missing data");var o=m()+"/"+n;t&&(t=JSON.stringify(t)),s.access_token&&(o=o+"?access_token="+s.access_token),"GET"===e&&t&&(o=o+(s.access_token?"&":"?")+"filter="+t);var c=new XMLHttpRequest;c.onreadystatechange=function(){4===this.readyState&&(200!=this.status?r():r(null,JSON.parse(this.responseText)))},c.open(e,o,!0),c.setRequestHeader("Content-type","application/json"),c.send("GET"!==e?t:null)},x=function(e){e&&void 0!==e||(e=l);var n=b();s.customerId&&(n.customerId=s.customerId),s.agentId&&(n.agentId=s.agentId),s.source&&(n.source=s.source),n.ip=r(),n.identifier=s.cleanerIdentifier,h("POST","DeviceData",n,function(n,t){t&&t.id?(s.deviceId=t.id,o("tracker_device_id",t.id,.5)):console.error("Could not create tracking device"),e(n,t)})},O=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===n?"":decodeURIComponent(n[1].replace(/\+/g," "))},b=function(){var e,n,t,i=navigator.userAgent,r=navigator.appName,o=""+parseFloat(navigator.appVersion);return-1!=(n=i.indexOf("Opera"))?(r="Opera",o=i.substring(n+6),-1!=(n=i.indexOf("Version"))&&(o=i.substring(n+8))):-1!=(n=i.indexOf("MSIE"))?(r="Microsoft Internet Explorer",o=i.substring(n+5)):-1!=(n=i.indexOf("Chrome"))?(r="Chrome",o=i.substring(n+7)):-1!=(n=i.indexOf("Safari"))?(r="Safari",o=i.substring(n+7),-1!=(n=i.indexOf("Version"))&&(o=i.substring(n+8))):-1!=(n=i.indexOf("Firefox"))?(r="Firefox",o=i.substring(n+8)):(e=i.lastIndexOf(" ")+1)<(n=i.lastIndexOf("/"))&&(r=i.substring(e,n),o=i.substring(n+1),r.toLowerCase()==r.toUpperCase()&&(r=navigator.appName)),-1!=(t=o.indexOf(";"))&&(o=o.substring(0,t)),-1!=(t=o.indexOf(" "))&&(o=o.substring(0,t)),{browser:r,browserVersion:o,os:y()}},y=function(){return-1!=navigator.appVersion.indexOf("Win")?"Windows":-1!=navigator.appVersion.indexOf("Mac")?"MacOS":-1!=navigator.appVersion.indexOf("X11")?"UNIX":-1!=navigator.appVersion.indexOf("Linux")?"Linux":"Unkown"}}(window,document);